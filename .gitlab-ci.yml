stages:
    - build
    - docs
    - deploy

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# Build STL files
build:
    stage: build
    image: ubuntu:18.04

    before_script:
      - apt-get update -qq
      - apt-get -y -qq install software-properties-common dirmngr apt-transport-https lsb-release ca-certificates python3-pip
      - add-apt-repository -y ppa:openscad/releases
      - apt-get update -qq
      - apt-get install -y -qq openscad
      # - pip3 install -r requirements.txt

    script:
      # Build STL files with OpenSCAD
      - mkdir -p /root/.local/share
      - ./build.sh
      - cd openflexure-microscope/
      - "git checkout 4dfc357ee2cffe9bf95603c26d42fa8b9b22fec6"
      - cd ..
      - ./build_newfiles.sh

    artifacts:
      expire_in: 1 week
      name: "${CI_PROJECT_NAME}-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}"
      paths:
        - builds/*.stl

    only:
      - tags
      - merge_requests
      - web

build-docs:
    stage: docs
    dependencies:
      - build
    image: "python:3.7"

    before_script:
      - python --version
      - pip install gitbuilding

    script:
      - cd docs
      - cp -r ../builds/* models/
      - gitbuilding build
      - gitbuilding build-html
      - cd ..
      - mv docs/_site public

    artifacts:
        paths:
        - public
    only:
      - tags
      - merge_requests
      - web

# Deploy to builds.openflexure.org
deploy:
  stage: deploy
  dependencies:
    - build
    - build-docs
  image: ubuntu:latest

  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY_BATH_OPENFLEXURE_BASE64" | base64 --decode)
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

  script:
    # Install rsync if not already installed
    - 'which rsync || ( apt-get update -y && apt-get install rsync -y )'

    # Upload the builds folder to openflexure-microscope builds
    - rsync -hrvz -e ssh public/ ci-user@openflexure.bath.ac.uk:/var/www/build/${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME} --delete

    # Zip the builds folder and upload it to the openflexure-microscope build root
    - 'which zip || ( apt-get update -y && apt-get install zip -y )'
    - (cd public && zip -r "../${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}.zip" .)
    - rsync -hrvz -e ssh "${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}.zip" ci-user@openflexure.bath.ac.uk:/var/www/build/${CI_PROJECT_NAME}/

    # Run update-latest.py on the build server
    - ssh -t ci-user@openflexure.bath.ac.uk "/var/www/build/update-latest.py"

  artifacts:
    expire_in: 1 week
    name: "${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}.zip"
    paths:
      - "${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}.zip"

  only:
    - tags
    - web
